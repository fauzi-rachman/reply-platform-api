# GitHub Copilot Context

This file provides context for GitHub Copilot and AI coding agents working on this project.

## Project Type
REST API built with TypeScript for Cloudflare Workers

## Tech Stack
- Runtime: Cloudflare Workers (V8 isolates)
- Framework: Hono (web framework)
- Database: Cloudflare D1 (SQLite)
- Language: TypeScript
- Auth: Google OAuth 2.0 + JWT

## Code Patterns to Follow

### Route Handler Pattern
```typescript
import { Hono } from 'hono';
import { Env } from './types';
import { authMiddleware } from './utils';

const router = new Hono<Env>();

// Public route
router.get('/public', async (c) => {
  return c.json({ message: 'Public endpoint' });
});

// Protected route
router.get('/protected', authMiddleware, async (c) => {
  const userId = c.get('userId');
  return c.json({ userId });
});

export default router;
```

### Database Query Pattern
```typescript
// D1 requires prepared statements
const user = await c.env.DB.prepare(
  'SELECT * FROM users WHERE id = ?'
).bind(userId).first();

// For INSERT/UPDATE/DELETE
const result = await c.env.DB.prepare(
  'INSERT INTO users (id, email, name) VALUES (?, ?, ?)'
).bind(id, email, name).run();
```

### Error Handling Pattern
```typescript
try {
  // Database operation
  const result = await c.env.DB.prepare('...').bind(...).first();
  
  if (!result) {
    return c.json({ error: 'Not found' }, 404);
  }
  
  return c.json(result);
} catch (error) {
  console.error('Error:', error);
  return c.json({ error: 'Internal server error' }, 500);
}
```

## File Purposes

### src/index.ts
Main application file that:
- Initializes Hono app
- Configures CORS middleware
- Mounts route modules
- Defines health check endpoint

### src/types.ts
TypeScript type definitions:
- Env: Cloudflare Workers environment bindings
- User: User database model
- Website: Website database model
- JWTPayload: JWT token structure
- Google OAuth types

### src/utils.ts
Utility functions:
- signJWT: Create JWT tokens
- verifyJWT: Validate JWT tokens
- authMiddleware: Protect routes
- generateId: Create UUIDs
- hashPassword/verifyPassword: Password handling

## Environment Access

```typescript
// In route handlers, access environment via context
const db = c.env.DB;
const clientId = c.env.GOOGLE_CLIENT_ID;
const secret = c.env.JWT_SECRET;
```

## Common Tasks

### Add New Table
1. Update schema.sql with CREATE TABLE
2. Add interface to src/types.ts
3. Run: npm run db:migrate:local

### Add New Route
1. Create route handler function
2. Import in src/index.ts
3. Mount with app.route()

### Add Middleware
```typescript
export async function myMiddleware(c: Context<Env>, next: () => Promise<void>) {
  // Pre-processing
  await next();
  // Post-processing
}
```

## Important Constraints

- D1 uses SQLite syntax (not PostgreSQL or MySQL)
- Cloudflare Workers have CPU time limits (10ms-50ms per request)
- No file system access (use KV or D1 for persistence)
- Use Web APIs (fetch, crypto, etc.), not Node.js APIs
- Bundle size matters (keep dependencies minimal)

## Testing Checklist

When adding new features:
- [ ] Add TypeScript types
- [ ] Add error handling
- [ ] Update documentation
- [ ] Test in dev server (npm run dev)
- [ ] Test type checking (npm run type-check)
- [ ] Consider edge cases

## Documentation Structure

- docs/API.md - API endpoint reference
- docs/ARCHITECTURE.md - System design
- docs/DEVELOPMENT.md - Local setup
- docs/DEPLOYMENT.md - Production deployment
- docs/TROUBLESHOOTING.md - Common issues
- docs/EXAMPLES.md - Code examples

## Best Practices

1. Always use prepared statements for SQL
2. Validate user input before database operations
3. Use authMiddleware for protected routes
4. Return appropriate HTTP status codes
5. Include descriptive error messages
6. Add JSDoc comments for exported functions
7. Use TypeScript types everywhere

## Anti-Patterns to Avoid

❌ String concatenation in SQL:
```typescript
const query = `SELECT * FROM users WHERE id = '${userId}'`; // SQL injection risk
```

✅ Use prepared statements:
```typescript
const result = await db.prepare('SELECT * FROM users WHERE id = ?').bind(userId).first();
```

❌ Forgetting authentication:
```typescript
app.get('/user-data', async (c) => { ... }); // Unprotected route
```

✅ Add authMiddleware:
```typescript
app.get('/user-data', authMiddleware, async (c) => { ... });
```

## Quick Commands

```bash
npm run dev              # Start dev server
npm run type-check       # Check types
npm run deploy           # Deploy to production
npm run db:migrate:local # Run migrations locally
```

## External Dependencies

Only one production dependency:
- hono: Web framework for edge computing

Keep it minimal - Cloudflare Workers charge for CPU time.
